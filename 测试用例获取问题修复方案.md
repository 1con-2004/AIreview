 # 测试用例获取问题修复方案

## 问题描述

当点击题目的引用按钮时，弹出的窗口中无法正常获取测试用例数据。测试用例数据存储在 `problem_pool_test_cases` 表中，使用 `problem_pool_id` 字段与题目关联。

## 问题原因

通过分析代码和数据库结构，发现以下几个问题：

1. ProblemImportDialog 组件在尝试获取测试用例时使用了单独的 API `/api/admin/problem-pool/${id}/test-cases`
2. 虽然后端有正确实现该 API，但是前端在处理返回的测试用例数据时可能存在问题
3. 数据库查询确认测试用例表 `problem_pool_test_cases` 中确实有数据

## 修复方案

### 方案1: 修改 ProblemImportDialog 组件

在 `frontend/src/components/problem/ProblemImportDialog.vue` 文件中，修改测试用例获取的逻辑：

```javascript
// 尝试加载测试用例数据
try {
  // 向后端请求该题目的测试用例
  console.log('开始请求测试用例，题目ID:', props.problem.id)
  const testCasesResponse = await axios.get(`/api/admin/problem-pool/${props.problem.id}/test-cases`)
  console.log('测试用例API响应:', testCasesResponse)
  
  if (testCasesResponse.data && testCasesResponse.data.success && testCasesResponse.data.data) {
    // 转换测试用例格式以适配前端
    const testCasesData = testCasesResponse.data.data;
    console.log('原始测试用例数据:', testCasesData);
    
    if (testCasesData && testCasesData.length > 0) {
      formData.testcases = testCasesData.map(tc => ({
        input: tc.input || '',
        output: tc.output || '',
        is_example: tc.is_example === 1 || tc.is_example === true,
        order_num: tc.order_num || 0
      }));
      console.log('处理后的测试用例:', formData.testcases);
    } else {
      console.log('测试用例数据为空，添加默认测试用例');
      addTestcase();
    }
  } else {
    console.log('没有找到测试用例数据或者数据格式不正确')
    // 如果没有测试用例数据，添加一个默认的空测试用例
    addTestcase()
  }
} catch (err) {
  console.error('加载测试用例失败:', err)
  console.error('错误详情:', err.response ? err.response.data : '无响应')
  // 添加默认测试用例
  addTestcase()
}
```

### 方案2: 修改 problemPoolController 中的 getProblemTestCases 方法

在 `backend/src/controllers/problemPoolController.js` 文件中，修改 `getProblemTestCases` 方法：

```javascript
/**
 * 获取题目测试用例
 * @param {Object} req Express请求对象
 * @param {Object} res Express响应对象
 * @returns {void}
 */
async function getProblemTestCases(req, res) {
  try {
    const id = parseInt(req.params.id);
    if (isNaN(id)) {
      return res.status(400).json({
        success: false,
        error: {
          code: 'VALIDATION_ERROR',
          message: '无效的题目ID'
        }
      });
    }
    
    console.log(`正在获取题目ID[${id}]的测试用例`);
    
    // 直接从数据库查询测试用例
    const pool = require('../db');
    const [rows] = await pool.query(
      'SELECT * FROM problem_pool_test_cases WHERE problem_pool_id = ? ORDER BY order_num',
      [id]
    );
    
    console.log(`找到${rows.length}个测试用例`);
    
    res.json({
      success: true,
      data: rows
    });
  } catch (error) {
    console.error('获取题目测试用例失败:', error);
    
    if (error.message === '题目不存在') {
      return res.status(404).json({
        success: false,
        error: {
          code: 'PROBLEM_NOT_FOUND',
          message: '题目不存在'
        }
      });
    }
    
    res.status(500).json({
      success: false,
      error: {
        code: 'SERVER_ERROR',
        message: error.message || '获取题目测试用例失败'
      }
    });
  }
}
```

### 方案3: 修改 problem-pool.vue 中的引用题目方法

在 `frontend/src/views/admin/problem-pool.vue` 文件中，修改 `importProblem` 方法，在获取题目详情后同时获取测试用例：

```javascript
// 引用题目
const importProblem = async (problem) => {
  try {
    // 先获取完整的题目详情
    const response = await axios.get(`/api/admin/problem-pool/${problem.id}`);
    
    if (!response.data || !response.data.success) {
      console.error('获取题目详情失败:', response.data);
      alert('获取题目详情失败，请稍后重试');
      return;
    }
    
    const fullProblemData = response.data.data;
    console.log('完整题目详情:', fullProblemData);
    
    // 获取测试用例
    const testCasesResponse = await axios.get(`/api/admin/problem-pool/${problem.id}/test-cases`);
    const testCases = testCasesResponse.data && testCasesResponse.data.success ? 
      testCasesResponse.data.data.map(tc => ({
        input: tc.input || '',
        output: tc.output || '',
        is_example: tc.is_example === 1 || tc.is_example === true
      })) : [];
    
    console.log('获取到的测试用例:', testCases);
    
    // 确保题目包含所有必要字段，如果后端返回的数据缺少某些字段，设置默认值
    const completeProblem = {
      ...problem,
      ...fullProblemData.problem, // 合并后端返回的详细信息
      time_limit: fullProblemData.problem.time_limit || problem.time_limit || 1000,
      memory_limit: fullProblemData.problem.memory_limit || problem.memory_limit || 256,
      description: fullProblemData.problem.description || problem.description || '',
      // 确保这些字段存在，即使为空
      tags: fullProblemData.problem.tags || problem.tags || '',
      category: fullProblemData.problem.category_name || fullProblemData.problem.category || problem.category || '',
      // 添加测试用例
      testcases: testCases.length > 0 ? testCases : [{
        input: '',
        output: '',
        is_example: true
      }]
    };
    
    console.log('引用题目详情:', completeProblem);
    selectedProblem.value = completeProblem;
    showImportDialog.value = true;
  } catch (error) {
    console.error('获取题目详情失败:', error);
    alert('获取题目详情失败，请稍后重试');
  }
}
```

## 调试建议

1. 在浏览器中打开开发者工具，查看网络请求和控制台输出
2. 检查测试用例 API 请求是否返回了正确的数据
3. 通过添加 `console.log` 语句跟踪数据流，确定问题发生的具体位置

## 数据模型参考

`problem_pool_test_cases` 表结构：
```
Field          Type        Null  Key    Default
id             int         NO    PRI    NULL    auto_increment
problem_number varchar(10) YES   MUL    NULL
problem_pool_id int        NO    MUL    NULL
input          text        NO           NULL
output         text        NO           NULL
is_example     tinyint(1)  YES          0
order_num      int         YES          0
created_at     timestamp   YES          CURRENT_TIMESTAMP
updated_at     timestamp   YES          CURRENT_TIMESTAMP
```