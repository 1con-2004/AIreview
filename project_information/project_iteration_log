# 项目迭代日志

{ 2025.4.17 } 改动: 修复用户删除功能的外键约束问题

主要改动文件:

1. - backend
    |- src
      |- api
        |- user
          |- index.js
            |- description: 用户API相关文件，修复了删除用户时的外键约束问题。

主要改动逻辑:

- 在删除用户前，先处理该用户在各个表中的外键引用关系
- 对于关键业务数据（如社区、课堂等），将用户引用更新为管理员ID(1)
- 对于用户个人数据（如提交记录、点赞等），直接删除相关记录
- 所有操作在事务中执行，确保数据一致性

问题出现原因:

- 数据库设计时，多个表通过外键约束引用了users表的id字段
- 删除用户时，由于这些外键约束的存在，MySQL阻止删除被引用的用户记录
- 原始代码未处理这些外键关系，导致删除操作失败

解决问题使用的简要方案:

- 识别所有引用users表的外键约束
- 对不同类型的数据采用不同策略：关键业务数据转移所有权，用户个人数据直接删除
- 使用事务确保所有操作的原子性，任何步骤失败都会回滚整个操作

{ 2025.4.18 } 改动: 新增测试用户账户和班级数据

主要改动文件:

1. - backend
    |- public
      |- uploads
        |- avatars
          |- description: 新增20个用户头像文件，命名格式符合系统规范。

2. - docs
    |- accounts.md
      |- description: 记录新增的20个测试账户信息，包括用户名、密码、权限等详细资料。

主要改动逻辑:

- 在数据库中创建10个不同专业的班级
- 新增20个不同权限的用户账户：2个管理员、5个教师、3个超级VIP、10个普通用户
- 为每个用户生成随机头像并保存到系统中
- 为每个用户创建详细的个人资料和学生信息，分配到不同班级和专业
- 将所有账户信息记录到accounts.md文件中，便于测试和演示

问题出现原因:

- 系统需要更多测试用户数据，以便测试不同权限的功能和数据展示效果
- 需要多个班级数据用于测试班级管理和数据统计功能

解决问题使用的简要方案:

- 使用系统现有的密码加密机制创建账户，确保所有用户密码一致便于测试
- 利用公开API获取随机头像，避免版权问题
- 模拟真实学校的班级和专业命名规则，创建有意义的测试数据
- 完整记录所有添加的数据，便于后续参考和使用

{ 2025.4.18 } 改动: 优化problems表和problem_categories表结构

主要改动文件:

1. - backend
    |- database
      |- schema
        |- problem_categories.sql
          |- description: 修改了problem_categories表结构，增加了更多描述性字段。
        |- problem_category_relations.sql
          |- description: 新增中间表存储问题和分类的多对多关系。
        |- triggers.sql
          |- description: 新增触发器，自动维护问题和分类的关联关系。

主要改动逻辑:

- 重构了problem_categories表，增加level、slug、icon等字段，更好地支持分类层次结构
- 创建problem_category_relations中间表，实现问题和分类的多对多关系管理
- 基于problems表的tags字段，提取出所有标签，作为分类添加到新表中
- 创建触发器，当问题的tags字段变化时，自动更新关联表
- 将原有表中的数据迁移到新表结构中，确保数据不丢失

问题出现原因:

- 原问题分类结构不够灵活，缺乏层次关系
- 原系统中的标签和分类是分离的，导致功能重复和维护困难
- 标签存储在problems表的tags字段中，格式为逗号分隔的字符串，不利于高效查询

解决问题使用的简要方案:

- 采用树形分类结构，通过parent_id建立层次关系
- 使用中间表存储多对多关系，优化查询效率
- 添加触发器自动维护关系，减少维护成本
- 保留problems表的tags字段作为兼容层，但将实际分类管理转移到专门的表中

