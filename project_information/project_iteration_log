# 项目迭代日志

{ 2025.4.17 } 改动: 修复用户删除功能的外键约束问题

主要改动文件:

1. - backend
    |- src
      |- api
        |- user
          |- index.js
            |- description: 用户API相关文件，修复了删除用户时的外键约束问题。

主要改动逻辑:

- 在删除用户前，先处理该用户在各个表中的外键引用关系
- 对于关键业务数据（如社区、课堂等），将用户引用更新为管理员ID(1)
- 对于用户个人数据（如提交记录、点赞等），直接删除相关记录
- 所有操作在事务中执行，确保数据一致性

问题出现原因:

- 数据库设计时，多个表通过外键约束引用了users表的id字段
- 删除用户时，由于这些外键约束的存在，MySQL阻止删除被引用的用户记录
- 原始代码未处理这些外键关系，导致删除操作失败

解决问题使用的简要方案:

- 识别所有引用users表的外键约束
- 对不同类型的数据采用不同策略：关键业务数据转移所有权，用户个人数据直接删除
- 使用事务确保所有操作的原子性，任何步骤失败都会回滚整个操作

{ 2025.4.18 } 改动: 新增测试用户账户和班级数据

主要改动文件:

1. - backend
    |- public
      |- uploads
        |- avatars
          |- description: 新增20个用户头像文件，命名格式符合系统规范。

2. - docs
    |- accounts.md
      |- description: 记录新增的20个测试账户信息，包括用户名、密码、权限等详细资料。

主要改动逻辑:

- 在数据库中创建10个不同专业的班级
- 新增20个不同权限的用户账户：2个管理员、5个教师、3个超级VIP、10个普通用户
- 为每个用户生成随机头像并保存到系统中
- 为每个用户创建详细的个人资料和学生信息，分配到不同班级和专业
- 将所有账户信息记录到accounts.md文件中，便于测试和演示

问题出现原因:

- 系统需要更多测试用户数据，以便测试不同权限的功能和数据展示效果
- 需要多个班级数据用于测试班级管理和数据统计功能

解决问题使用的简要方案:

- 使用系统现有的密码加密机制创建账户，确保所有用户密码一致便于测试
- 利用公开API获取随机头像，避免版权问题
- 模拟真实学校的班级和专业命名规则，创建有意义的测试数据
- 完整记录所有添加的数据，便于后续参考和使用

{ 2025.4.18 } 改动: 优化problems表和problem_categories表结构

主要改动文件:

1. - backend
    |- database
      |- schema
        |- problem_categories.sql
          |- description: 修改了problem_categories表结构，增加了更多描述性字段。
        |- problem_category_relations.sql
          |- description: 新增中间表存储问题和分类的多对多关系。
        |- triggers.sql
          |- description: 新增触发器，自动维护问题和分类的关联关系。

主要改动逻辑:

- 重构了problem_categories表，增加level、slug、icon等字段，更好地支持分类层次结构
- 创建problem_category_relations中间表，实现问题和分类的多对多关系管理
- 基于problems表的tags字段，提取出所有标签，作为分类添加到新表中
- 创建触发器，当问题的tags字段变化时，自动更新关联表
- 将原有表中的数据迁移到新表结构中，确保数据不丢失

问题出现原因:

- 原问题分类结构不够灵活，缺乏层次关系
- 原系统中的标签和分类是分离的，导致功能重复和维护困难
- 标签存储在problems表的tags字段中，格式为逗号分隔的字符串，不利于高效查询

解决问题使用的简要方案:

- 采用树形分类结构，通过parent_id建立层次关系
- 使用中间表存储多对多关系，优化查询效率
- 添加触发器自动维护关系，减少维护成本
- 保留problems表的tags字段作为兼容层，但将实际分类管理转移到专门的表中

{ 2025-05-20 } 改动: 修复 problems/index.vue 页面题目完成状态追踪功能

主要改动文件:

1. - frontend
    |- src
      |- views
        |- problems
          |- index.vue
            |- description: 题目列表页面，添加了获取用户题目完成状态的功能。

2. - backend
    |- src
      |- api
        |- problems
          |- index.js
            |- description: 添加了获取用户题目完成状态的API端点。

主要改动逻辑:

- 在前端的 `index.vue` 文件中，添加了 `fetchUserProblemStatus` 方法，在获取题目列表后调用该方法获取用户的题目完成状态。
- 在后端 `problems/index.js` 中，添加了 `/api/problems/user-status` 端点，通过查询 submissions 表获取用户最新的题目提交状态。

问题出现原因:

- 由于之前删除了 user_problem_status 表，导致题目列表页面无法跟踪用户是否完成了题目。

解决问题使用的简要方案:

- 参考学习计划详情页面 (learning-plans/detail.vue) 的实现方式，不再依赖已删除的 user_problem_status 表，而是直接查询 submissions 表获取用户的题目完成状态。

{ 2023.05.29 } 改动: 将"AI中心"更名为"个人中心"

主要改动文件:

1. - frontend
    |- src
      |- views
        |- personal
          |- PersonalCenter.vue
            |- description: 新创建的个人中心组件，替代原来的AI中心组件。
      |- router
        |- index.js
          |- description: 更新了路由配置，从'/ai-center'改为'/personal-center'，组件从AICenter改为PersonalCenter。
      |- components
        |- NavBar.vue
          |- description: 修改了导航栏中的链接文本从"AI中心"改为"个人中心"，路径从"/ai-center"改为"/personal-center"。
      |- views
        |- home
          |- index.vue
            |- description: 修改了首页中的特性卡片，从"AI中心"改为"个人中心"，并更新了描述文本。

主要改动逻辑:

- 将所有与"AI中心"相关的组件、路由和链接更新为"个人中心"。
- 创建了新的个人中心组件文件夹和文件，将原来的AI中心文件夹和文件替换。
- 更新了导航栏、首页和路由配置中的相关文本和路径。

问题出现原因:

- 需要将原来的"AI中心"功能重新定位为更通用的"个人中心"，以便包含更多与用户个人相关的功能。

解决问题使用的简要方案:

- 创建新的个人中心组件，替换原来的AI中心组件。
- 更新所有相关的路由配置和链接。
- 保持功能的连续性，确保用户体验不受影响。

{ 2025-04-19 } 改动: 修复Java代码判题类名识别问题

主要改动文件:

1. - backend
    |- src
      |- services
        |- judge
          |- sandbox.js
            |- description: 判题沙箱服务文件，修改了Java代码执行部分的类名识别逻辑。

主要改动逻辑:

- 在`runJava`方法中，不再简单地使用临时文件名作为Java类名
- 添加代码从Java源文件内容中提取实际的类定义
- 通过正则表达式获取用户定义的类名
- 当找不到类定义时，默认使用"Solution"类名（与preprocessJavaCode方法中创建的默认类名一致）

问题出现原因:

- 判题系统会将用户提交的Java代码保存为临时文件（如temp_1745028165148.java）
- 原有代码简单地使用文件名（不带扩展名）作为类名，这不符合Java的类加载机制
- preprocessJavaCode方法会将用户代码封装在名为"Solution"的类中（如果用户未提供自己的类定义）
- 这导致系统尝试使用"temp_1745028165148"作为类名，而实际编译后的类名是"Solution"
- 最终造成"ClassNotFoundException"错误，无法正确运行用户提交的Java代码

解决问题使用的简要方案:

- 从Java源文件内容中提取实际的类名
- 确保使用正确的类名执行Java程序
- 当无法提取到类名时，使用默认的"Solution"类名

{ 2023.07.15 } 改动: 修复C++判题功能

主要改动文件:

1. - backend
   |- src
      |- services
         |- judge
            |- sandbox.js
               |- description: 该文件负责创建判题沙箱环境和处理代码执行，修改了对C++语言识别的逻辑，添加了对'c++'标识符的支持。
            |- executor.js
               |- description: 负责具体执行判题逻辑的文件，修改了语言处理部分，统一标准化C++相关的语言标识符。

主要改动逻辑:

- 在`sandbox.js`文件中的`createSandbox`函数中，添加了对'c++'语言标识符的支持，将其映射到gcc镜像。
- 添加了将'c++'标准化为'cpp'的逻辑，使系统内部处理时统一使用'cpp'作为标识符。
- 在`execute`、`executeDebug`、`run`和`preprocessCode`方法中都添加了对'c++'的处理逻辑。

问题出现原因:

- 后端判题服务中只支持'cpp'作为C++语言的标识符，而前端提交时使用的是'C++'，经过转小写后变成'c++'，系统无法识别。

解决问题使用的简要方案:

- 添加对'c++'标识符的支持，并在内部统一转换为'cpp'进行处理，保持代码处理逻辑的一致性。

{ 2023.11.13 } 改动: 修复代码提交后答案显示的代码高亮失效问题

主要改动文件:

1. - frontend
    |- src
      |- views
        |- problems
          |- detail
            |- ProblemDetail.vue
              |- description: 问题详情页面，修复了代码高亮失效的问题

主要改动逻辑:

- 在提交代码后添加了自动应用代码高亮的逻辑，确保在切换到"提交记录"标签页时，代码高亮仍能正常工作。
- 增加了在切换标签页（特别是切换到"解决方案"和"提交记录"标签）时自动应用代码高亮的功能。
- 修改了解决方案代码块的语言类名，从固定的"language-javascript"改为动态绑定的语言类型，确保根据不同语言正确应用高亮。
- 在显示提交详情和获取提交记录后，添加了自动应用代码高亮的逻辑，确保在各种场景下代码高亮都能正常工作。
- 导入了所有支持的编程语言（C、C++、Java、Python、JavaScript）的Prism语法高亮模块。
- 添加了语言标识符标准化处理，如将"C++"映射为"cpp"，确保所有语言正确高亮。

问题出现原因:

- 在提交代码后，切换标签页过程中没有重新应用代码高亮，导致页面中的代码块失去了高亮效果。
- 解决方案代码块使用了固定的语言类型"javascript"，没有根据实际代码语言动态调整。
- Prism.js库默认只导入了C语言的语法支持，缺少对其他语言如Java、Python、C++的支持。
- 缺少对语言标识符的标准化处理机制，导致无法正确识别某些语言。

解决问题使用的简要方案:

- 使用Vue的nextTick函数确保DOM更新后再应用代码高亮。
- 在关键点（提交代码、切换标签页、显示提交详情、获取记录后）调用Prism.highlightAll()重新应用高亮。
- 对代码块使用动态类名绑定，确保根据代码的实际语言类型应用正确的高亮。
- 导入所有需要支持的编程语言的Prism高亮模块。
- 创建语言标识符映射函数，将各种常见的语言名称映射到Prism支持的标准标识符。

